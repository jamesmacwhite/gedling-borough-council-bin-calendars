{% if jekyll.environment != 'production' %}
    {% assign apiUrl = 'http://localhost:8787/get-bin-collection-calendar?address=' %}
{% else %}
    {% assign apiUrl = site.calendarSearchUrl %}
{% endif %}

<p class="d-print-none">For best results, use searches like "101 Arnold Lane" or full addresses like "101 Arnold Lane Gedling Nottingham NG4 4HE"</p>

<form id="calendar-collection-dates" class="d-print-none">
    <div class="mb-4">
        <label for="address" class="form-label fw-bold">Enter your address</label>
        <input type="search" class="form-control bg-white form-control-lg mb-3" id="address" placeholder="E.g. 101 Arnold Lane" required>
        <button id="collection-search-btn" type="submit" class="btn btn-lg btn-gedling-red">
            Get collection dates
        </button>  
    </div>
</form>

<div id="calendar-collections-data" role="region" aria-live="polite" class="bg-light mb-4 p-3 border border-1 mb-3 d-none"></div>

<script>
    const calendarForm = document.querySelector('#calendar-collection-dates');
    let addressInput = document.querySelector('#address');
    let calendarCollectionData = document.querySelector('#calendar-collections-data');

    calendarForm.addEventListener('submit', event => {

        event.preventDefault();
        calendarCollectionData.classList.remove('d-none');

        calendarCollectionData.innerHTML = `
        <div class="d-flex justify-content-center gap-3">
            <div class="spinner-border" role="status"></div>
                Generating calendar data...
        </div>`;


        fetch(`{{ apiUrl }}${addressInput.value}`)
            .then((response) => {
                if (!response.ok) {
                    throw new Response(`HTTP error occurred. HTTP error: ${response.status} ${response.statusText}`);
                }

                return response.json();
            })
            .then((data) => {

                const address = data.address;
                const collections = data.collections;
                const binCollectionsCalendar = document.createElement("div");
                binCollectionsCalendar.id = 'refuse-schedule-container';
                binCollectionsCalendar.classList.add("row", "row-cols-1", "row-cols-sm-2", "row-cols-md-3", "g-4");

                calendarCollectionData.innerHTML = `
                <div class="d-none d-print-block bg-gedling-red p-2 mb-3">
                    <img src="{{ "/assets/images/gedling-logo-white.svg" | absolute_url }}" alt="Gedling Borough Council">
                </div>

                <h2 class="mb-2">Bin collection calendar for: <span class="text-gedling-red">${address}</span></h2>`;
                calendarCollectionData.innerHTML += `
                    <div class="d-flex mb-3 gap-3 d-print-none">
                        <a href="${data.binCollectionUrl}" class="btn btn-gedling-red">View collection dates</a>
                        <button onclick="window.print();" class="btn btn-secondary">Print calendar</button>
                    </div>`;

                data.collections.forEach(calendarMonth => {

                    const monthData = calendarMonth.month; 
                    const month = new Date(monthData + "-01");
                    const monthFormatted = new Intl.DateTimeFormat("en-GB", { month: "long", year: "numeric" }).format(month);

                    const calendarDates = document.createElement("div");
                    calendarDates.classList.add("col");
                    calendarDates.innerHTML += `<h3 class="schedule-title">${monthFormatted}</h3>`;

                    calendarMonth.dates.forEach(occurrence => {
                        const iconMap = {
                            "General Collection Service": "trash-fill",
                            "Glass Collection Service": "archive-fill",
                            "Recycling Collection Service": "recycle",
                        };

                        // Re-label schedule names from API data
                        const scheduleLabelMap = {
                            "General Collection Service": "Black Bin Day",
                            "Glass Collection Service": "Glass Box Day",
                            "Recycling Collection Service": "Green Bin Day",
                        }

                        const item = document.createElement("div");
                        const d = new Date(occurrence.date); 
                        const day = d.getDate();
                        const weekday = d.toLocaleString("en-GB", { weekday: "long" } );
                        const suffix = ["th","st","nd","rd"][day % 10] || "th"; 

                        item.innerHTML = `
                        <div class="date my-2 fw-bold schedule-title">${weekday} ${day}${suffix}</div>
                        <ul class="list-unstyled schedule-item">
                            ${occurrence.collections.map(s => `<li>${scheduleLabelMap[s] || s} <i class="bi bi-${iconMap[s]}" aria-hidden="true"></i></li>`).join("")}
                        </ul>
                        `;

                        calendarDates.appendChild(item);
                    });

                    binCollectionsCalendar.appendChild(calendarDates);
                });

                calendarCollectionData.appendChild(binCollectionsCalendar);
                calendarCollectionData.scrollIntoView();

                window.dataLayer.push({
                    'event': 'calendar_collection_search',
                    'address': addressInput.value
                });
            })
            .catch((error) => {
                calendarCollectionData.innerHTML = `<p class="text-danger fw-bold mb-0">${error}</p>`
                console.error("Error fetching data:", error);
            });
    });
</script>