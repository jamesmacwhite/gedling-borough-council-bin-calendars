{% if jekyll.environment != 'production' %}
    {% assign apiUrl = 'http://localhost:8787?streetName=' %}
{% else %}
    {% assign apiUrl = site.collectionSearchUrl %}
{% endif %}

<form id="collection-search">
    <label for="street-name" class="form-label fw-bold">Enter your street name</label>
    <input type="text" class="form-control" id="street-name" placeholder="Oxclose Lane" required>

    <button type="submit" class="btn btn-primary mt-2 mb-3">Search</button>
</form>

<div aria-live="polite" class="collection-search-result bg-light mb-4 p-3 border border-1 mb-3 d-none">
    <div class="row row-cols-1 row-cols-md-2 g-4"></div>
</div>

<script>
    let form = document.querySelector('form#collection-search');
    let searchResult = document.querySelector('.collection-search-result');

    form.addEventListener('submit', event => {
        event.preventDefault();

        let streetName = document.querySelector('#street-name');
        searchResult.classList.remove('d-none');

        fetch(`{{ apiUrl }}${streetName.value}`)
            .then((response) => {

                if (!response.ok) {

                    if (response.status === 404) {
                        throw new Error('The street name entered did not return any bin collection data. Please check the street name entered and try again.');
                    }

                    if (response.status === 500) { 
                        throw new Error('The Gedling Borough Council website did not provide a valid response to the request.');
                    }
                    
                    throw new Error(`HTTP error occurred. HTTP error: ${response.status} ${response.statusText}`);
                }

                return response.json();
            })
            .then((data) => {
                let refuseCollections = data.refuseCollections;
                let gardenWasteCollections = data.gardenWasteCollections;

                searchResult.innerHTML = '';
                
                const rowWrapper = document.createElement('div');
                rowWrapper.classList.add('row', 'row-cols-1', 'row-cols-md-2', 'g-4');
                searchResult.appendChild(rowWrapper);

                const refuseCol = document.createElement('div');
                refuseCol.classList.add('col');
                rowWrapper.appendChild(refuseCol);

                const gardenCol = document.createElement('div');
                gardenCol.classList.add('col');
                rowWrapper.appendChild(gardenCol);

                refuseCol.innerHTML += `<p class="mb-0 fw-bold">Your refuse/recycling ${refuseCollections.length === 1 ? 'collection is' : 'collections are'}:</p>`;

                refuseCollections.forEach(function(collection) {
                    refuseCol.innerHTML += `
                    <div class="refuse-collection-result">
                        <p class="fs-3 mb-0">
                            <a href="/collections/refuse/${collection['Schedule Identifier']}">
                                ${collection['Schedule Name']}
                            </a>
                        </p>
                        <p class="mb-0">${collection['Location']}, ${collection['Area']}</p>
                    </div>`
                });

                gardenCol.innerHTML += `<p class="mt-2 mb-0 fw-bold">Your garden waste ${gardenWasteCollections.length === 1 ? 'collection is' : 'collections are'}:</p>`;

                gardenWasteCollections.forEach(function(collection) {
                    gardenCol.innerHTML += `
                    <div class="garden-waste-collection-result">
                        <p class="fs-3 mb-0">
                            <a href="/collections/garden/${collection['Schedule Identifier']}">
                                ${collection['Schedule Name']}
                            </a>
                        </p>
                        <p class="mb-0">${collection['Location']}, ${collection['Numbers'] !== null ? collection['Numbers'] + ',' : ''} ${collection['Area']}</p>
                    </div>`
                });
            })
            .catch((error) => {
                searchResult.innerHTML = `<p class="text-danger fw-bold mb-0">${error}</p>`
                console.error("Error fetching data:", error);
            });
    });
</script>